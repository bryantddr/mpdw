---
title: "Model ARIMA - Tugas Praktikum 7"
author: "Bryant Indervil Deadora G1401231062"
output:
  rmdformats::downcute:
    downcute_theme: chaos
    self_contained: true
    code_download: true
    toc_float: true
    toc_depth: 4
    df_print: paged
    code_folding: show
    theme: cerulean
    highlight: kate
---

# Import Packages

```{r,warning=FALSE, message=FALSE}
library(rio)
library(tidyverse)
library(ggplot2)
library(tsibble)
library(tseries)
library(MASS)
library(forecast)
library(TSA)
```

# Import Data

```{r}
df <- import("https://raw.githubusercontent.com/bryantddr/mpdw/refs/heads/main/Pertemuan%202/Bitcoin.csv")
df <- df %>%
  mutate(
    Price = gsub(pattern = ",", replacement = "", x = Price),
    Price = as.numeric(Price),
    Price = Price/1000)
dt <- df[379:504,2]
ts.dt <- ts(dt)
```

# Splitting Data

```{r}
dt.train <- dt[1:floor(0.8*length(dt))]
dt.test <- dt[(floor(0.8*length(dt))+1): length(dt)]
```
```{r}
ts.dt.train <- ts(dt.train)
ts.dt.test <- ts(dt.test)
```


# Ekplorasi Data

## Plot Time Series

```{r}
plot_df <- ts.dt.train |> as_tsibble() |> 
  ggplot(aes(x = index, y = value)) + geom_line() + theme_bw() +
  xlab("Obs") + ylab("Price")
plot_df
```

```{r}
mean(ts.dt.train)
```

```{r}
lattice::densityplot(as.vector(ts.dt.train))
```

Berdasarkan plot, terlihat data tidak stasioner dalam rataan maupun ragam, ditandai data tidak menyebar di sekitar nilai tengahnya, cenderung adanya tren.

## Plot ACF

```{r}
acf(ts.dt.train)
```

Berdasarkan plot ACF, terlihat plot tails off slowly. Hal ini mengindikasikan terdapat tidak stationer dalam rataan.

## Uji ADF

```{r}
adf.test(ts.dt.train)
```

$H_0$ : Data tidak stasioner dalam rataan 
$H_1$ : Data stasioner dalam rataan

Berdasarkan hasil uji ADF, *p-value* = 0.1104 > 0.05 = $\alpha$, maka tak tolak $H_0$. Data tidak stasioner dalam rataan. Hal ini sesuai dengan *time series* dan ACF plot.

Dalam data ekonomi termasuk Bitcoin, hal ini hampir pasti terjadi. Oleh karena itu, akan dilakukan pengananan lebih lanjut.

## Uji Box-Cox

```{r}
index <- seq(1:100)

# Uji Box-Cox
bc <- boxcox(
  ts.dt.train  ~ index,
  lambda = seq(0, 5, by = 0.001)
)
```

```{r}
lambda <- bc$x[which.max(bc$y)]
lambda
```

```{r}
# Selang kepercayaan 95% untuk lambda
ci_lambda <- bc$x[bc$y > max(bc$y) - 0.5 * qchisq(0.95, 1)]

# Batas bawah dan batas atas
ci_lower <- min(ci_lambda)
ci_upper <- max(ci_lambda)

c(Batas_Bawah = ci_lower, Batas_Atas = ci_upper)
```

Hasil uji Box-Cox menunjukkan bahwa nilai $\lambda$ optimum adalah 0.132 dengan interval kepercayaan 95% (0,0.414). Selang tidak mengandung $\lambda$ = 1, maka data tidak stasioner dalam ragam.

# Penanganan Ketidakstasioneran

## Differencing

```{r}
ts.dt.train_diff1 <- diff(ts.dt.train, differences = 1)
```

## Plot Time Series

```{r}
plot_dt.train_diff1 <- ts.dt.train_diff1 |> as_tsibble() |> 
  ggplot(aes(x = index, y = value)) + geom_line() + theme_bw() +
  xlab("Obs") + ylab("Price")
plot_dt.train_diff1
```

Berdasarkan plot, data terlihat menyebar pada rataan yang berarti stasioner pada rataan. Namun, sekilas terlihat belum stasioner pada ragam.

## Plot ACF

```{r}
acf(ts.dt.train_diff1)
```

Berdasarkan Plot ACF, terlihat sudah stasioner dalam rataan. Hasil ini sama dengan time series plot.

## Uji ADF

```{r,warning=FALSE}
adf.test(ts.dt.train_diff1)
```

$H_0$ : Data tidak stasioner dalam rataan 
$H_1$ : Data stasioner dalam rataan

Berdasarkan uji ADF, *p-value* = 0.035 < 0.05 = $\alpha$, tolak H0. Data sudah stasioner pada rataan, sesuai dengan hasil dari *time series plot* dan plot ACF

## Uji Box-Cox

```{r}
index <- seq(1:99)

# Uji Box-Cox
bc <- boxcox(
  ts.dt.train_diff1 - min(ts.dt.train_diff1) + 1  ~ index,
  lambda = seq(0, 5, by = 0.001)
)
```


```{r}
# Selang kepercayaan 95% untuk lambda
ci_lambda <- bc$x[bc$y > max(bc$y) - 0.5 * qchisq(0.95, 1)]

# Batas bawah dan batas atas
ci_lower <- min(ci_lambda)
ci_upper <- max(ci_lambda)

c(Batas_Bawah = ci_lower, Batas_Atas = ci_upper)
```

Berdasarkan Uji Box-Cox, interval kepercayaan 95% $\lambda$ sebesar (0.471,1.133). Dalam selang ini terdapat nilai $\lambda$ = 1, maka data sudah stasioner dalam ragam.

# Identifikasi Model

```{r}
acf(ts.dt.train_diff1)
```

```{r}
pacf(ts.dt.train_diff1)
```

```{r}
eacf(ts.dt.train_diff1)
```

Identifikasi model menggunakan plot EACF dilakukan dengan melihat ujung segitiga pada pola segitiga nol. Dalam hal ini model tentatif yang terbentuk adalah ARIMA(1,1,1), ARIMA(1,1,2)

# Pendugaan Parameter Model Tentatif

```{r}
model1.da=Arima(ts.dt.train_diff1, order=c(0,0,1),method="ML")
summary(model1.da)
```

```{r}
lmtest::coeftest(model1.da)
```
```{r}
model2.da=Arima(ts.dt.train_diff1, order=c(1,0,0),method="ML")
summary(model2.da)
```
```{r}
lmtest::coeftest(model2.da)
```

```{r}
model3.da=Arima(ts.dt.train_diff1, order=c(1,0,1),method="ML")
summary(model3.da)
```

```{r}
lmtest::coeftest(model3.da)
```

```{r}
model4.da=Arima(ts.dt.train_diff1, order=c(1,0,2),method="ML")
summary(model4.da)
```
```{r}
lmtest::coeftest(model4.da)
```
```{r}
model5.da=Arima(ts.dt.train_diff1, order=c(2,0,2),method="ML")
summary(model5.da)
```
```{r}
lmtest::coeftest(model5.da)
```
# Ringkasan AIC

```{r}
model_tentatif <- data.frame(
  Model = c("ARIMA(0,0,1)","ARIMA(1,0,0)","ARIMA(1,0,1)", "ARIMA(1,0,2)",
            "ARIMA(2,0,2)"),
  AIC   = c(AIC(model1.da),AIC(model2.da), AIC(model3.da), AIC(model4.da), AIC(model5.da)),
  BIC   = c(BIC(model1.da),BIC(model2.da), BIC(model3.da), BIC(model4.da), BIC(model5.da))
)

model_tentatif
```
Berdasarkan pendugaan parameter di atas, nilai AIC terkecil dimiliki oleh model ARIMA(1,1,1) dan parameter model ARIMA(1,1,1) juga seluruhnya signifikan sehingga model yang dipilih adalah model ARIMA(1,1,1).

# Analisis Sisaan

## Ekplorasi Sisaan

```{r}
sisaan.da <- model3.da$residuals

par(mfrow = c(2,2),    
    mar = c(4,4,2,1),  
    oma = c(0,0,2,0))  

# Q-Q Plot
qqnorm(sisaan.da, main = "Normal Q-Q Plot")
qqline(sisaan.da, col = "blue", lwd = 2)

# Plot Sisaan vs Waktu
plot(sisaan.da, type = "p",
     main = "Plot Sisaan vs Waktu",
     xlab = "Waktu", ylab = "Sisaan")

# ACF
acf(sisaan.da, main = "ACF Sisaan")

# PACF
pacf(sisaan.da, main = "PACF Sisaan")
```

Berdasarkan plot kuantil-kuantil normal, secara eksploratif terlihat bahwa sisaan menyebar normal karena titik-titik cenderung menyebar di garis. Selain itu, lebar pita sebaran sisaan tampak tidak seragam, yang mengindikasikan adanya heterogenitas ragam. Sementara itu, plot ACF dan PACF sisaan dari model ARIMA(1,1,1) menunjukkan adanya spike signifikan pada lag ke 15, secara visual sisaan dapat terindikasi tidak saling bebas. Kondisi ini akan diuji lebih lanjut dengan uji formal.

## Uji Formal

```{r}
ks.test(sisaan.da,"pnorm")
```

$H_0$: Sisaan menyebar normal
$H_1$: Sisaan tidak menyebar normal

Berdasarkan uji KS tersebut, didapat p-value sebesar $7.506 \times 10^{-7}$ yang kurang dari taraf nyata 5% sehingga tolak 
dan menandakan bahwa sisaan tidak menyebar normal. Hal ini tidak sesuai dengan hasil eksplorasi menggunakan plot kuantil-kuantil normal.

```{r}
Box.test(sisaan.da, type = "Ljung")
```

$H_0$: Sisaan saling bebas
$H_1$: Sisaan tidak saling bebas

Berdasarkan uji Ljung-Box tersebut, didapat p-value sebesar 0.7935 yang lebih besar dari taraf nyata 5% sehingga gagal tolak $H_0$
dan menandakan bahwa sisaan saling bebas. Hal ini berbeda dengan eksplorasi.

```{r}
Box.test((sisaan.da)^2, type = "Ljung")
```

$H_0$: Ragam sisaan homogen
$H_1$: Ragam sisaan tidak homogen

Berdasarkan uji Ljung-Box terhadap sisaan kuadrat tersebut, didapat p-value sebesar 0.5253 yang lebih besar dari taraf nyata 5% sehingga gagal tolak $H_0$ dan menandakan bahwa ragam sisaan homogen.

```{r}
t.test(sisaan.da, mu = 0, conf.level = 0.95)
```

$H_0$: Nilai tengah sisaan sama dengan 0
$H_1$: Nilai tengah sisaan tidak sama dengan 0

Berdasarkan uji-t, didapat p-value sebesar 0.9869 yang lebih besar dari taraf nyata 5% sehingga gagal tolak $H_0$ dan menandakan bahwa nilai tengah sisaan sama dengan nol.


# Model Terbaik

```{r}
model3.da
```
```{r}
lmtest::coeftest(model3.da)
```

# Peramalan

Peramalan dilakukan untuk 26 hari ke depan

```{r}
ramalan.da <- forecast(model3.da, h = length(ts.dt.test))
```

```{r}
dt.ramalan.da <- ramalan.da$mean
plot(ramalan.da)
```
```{r}
pt_akhir_train <- tail(ts.dt.test, 1) 

forecast <- diffinv(dt.ramalan.da, differences = 1, xi = pt_akhir_train)
hasil <- forecast[-1]
hasil <- forecast[1:length(ts.dt.test)]

# Bandingkan aktual vs forecast
perbandingan.da <- cbind(
  Aktual   = ts.dt.test,
  Forecast = hasil
)

print(head(perbandingan.da, 10))  
```

```{r}
akurasi_test <- accuracy(hasil, ts.dt.test)
akurasi_test
```
```{r}
ts.plot(ts.dt, col = "black", lty = 1,
        xlab = "Waktu", ylab = "Price")

# Garis forecast
lines(101:(100+length(hasil)), hasil, col = "blue", lty = 2, lwd = 2)
legend("topleft", 
       legend = c("Data Aktual", "Forecast"),
       col = c("black", "blue"),
       lty = c(1,2,3), lwd = c(1,2,1), bty = "n")
```
```{r}
length(hasil)
```


